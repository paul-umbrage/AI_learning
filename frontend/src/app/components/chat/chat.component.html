<div class="chat-container">
  <div class="chat-header">
    <h2>AI Chat Assistant</h2>
    <p class="subtitle">Powered by OpenAI with RAG & Function Calling</p>
    
    <!-- Feature Toggles -->
    <div class="feature-toggles">
      <label class="toggle-label">
        <input type="checkbox" [checked]="useRag()" (change)="toggleRag()">
        <span>RAG (Retrieval-Augmented Generation)</span>
      </label>
      <label class="toggle-label">
        <input type="checkbox" [checked]="useFunctions()" (change)="toggleFunctions()">
        <span>Function Calling</span>
      </label>
    </div>
    
    <!-- Filename Filter -->
    @if (useRag()) {
      <div class="filename-filter">
        <label for="filename-input">Filter by Filename (optional):</label>
        <input
          id="filename-input"
          type="text"
          [(ngModel)]="filenameFilter"
          (ngModelChange)="onFilenameChange($event)"
          placeholder="e.g., example_ai_learning.pdf"
          class="filename-input"
        />
        @if (filenameFilter) {
          <button (click)="clearFilenameFilter()" class="clear-btn" title="Clear filter">Ã—</button>
        }
      </div>
    }
    
    <!-- Advanced Options Toggle -->
    <div class="advanced-toggle">
      <button (click)="toggleAdvancedOptions()" class="advanced-toggle-btn">
        <span>{{ showAdvancedOptions() ? 'â–¼' : 'â–¶' }} Advanced Options</span>
      </button>
    </div>
    
    <!-- Advanced Options Panel -->
    @if (showAdvancedOptions()) {
      <div class="advanced-options">
        @if (useRag()) {
          <div class="option-group">
            <label class="option-label">
              <input type="checkbox" [(ngModel)]="useReranking">
              <span>Use Reranking</span>
            </label>
            @if (useReranking) {
              <select [(ngModel)]="rerankStrategy" class="option-select">
                @for (strategy of rerankStrategies; track strategy) {
                  <option [value]="strategy">{{ strategy }}</option>
                }
              </select>
            }
          </div>
          
          <div class="option-group">
            <label class="option-label">
              <input type="checkbox" [(ngModel)]="useHybridSearch">
              <span>Use Hybrid Search</span>
            </label>
            @if (useHybridSearch) {
              <div class="weight-controls">
                <label>Vector Weight: {{ vectorWeight | number:'1.1-1' }}</label>
                <input type="range" min="0" max="1" step="0.1" [(ngModel)]="vectorWeight" (ngModelChange)="updateVectorWeight($event)" class="weight-slider">
                <label>Keyword Weight: {{ keywordWeight | number:'1.1-1' }}</label>
                <input type="range" min="0" max="1" step="0.1" [(ngModel)]="keywordWeight" (ngModelChange)="updateKeywordWeight($event)" class="weight-slider">
              </div>
            }
          </div>
          
          <div class="option-group">
            <label class="option-label">
              <input type="checkbox" [(ngModel)]="useQueryExpansion">
              <span>Use Query Expansion</span>
            </label>
          </div>
          
          <div class="option-group">
            <label class="option-label">
              <input type="checkbox" [(ngModel)]="detectHallucinations">
              <span>Detect Hallucinations</span>
            </label>
            @if (detectHallucinations) {
              <label class="option-label sub-option">
                <input type="checkbox" [(ngModel)]="useLlmVerification">
                <span>Use LLM Verification (more accurate)</span>
              </label>
            }
          </div>
        }
        
        <div class="option-group">
          <label class="option-label">
            <span>Prompt Strategy:</span>
            <select [(ngModel)]="promptStrategy" class="option-select">
              @for (strategy of promptStrategies; track strategy.value) {
                <option [value]="strategy.value">{{ strategy.label }}</option>
              }
            </select>
          </label>
        </div>
      </div>
    }
  </div>

  <div class="messages-container">
    @for (message of messages(); track $index) {
      <div class="message" [class.user-message]="message.isUser" [class.ai-message]="!message.isUser">
        <div class="message-content">
          <div class="message-text">{{ message.text }}</div>
          
          <!-- RAG Sources -->
          @if (message.sources && message.sources.length > 0) {
            <div class="sources-section">
              <div class="sources-header">ðŸ“š Sources:</div>
              @for (source of message.sources; track source.chunk_index) {
                <div class="source-item">
                  <div class="source-header" (click)="toggleSourcePreview(source.chunk_index)">
                    <span class="source-index">[{{ source.chunk_index }}]</span>
                    <span class="source-filename">{{ source.filename }}</span>
                    <span class="source-page">Page {{ source.page_number }}</span>
                    <span class="source-similarity">Similarity: {{ source.similarity | number:'1.2-2' }}</span>
                    <span class="toggle-icon">{{ isSourceExpanded(source.chunk_index) ? 'â–¼' : 'â–¶' }}</span>
                  </div>
                  @if (isSourceExpanded(source.chunk_index)) {
                    <div class="source-preview">
                      <div class="source-preview-text">{{ source.text_preview || 'No preview available' }}</div>
                    </div>
                  }
                </div>
              }
            </div>
          }
          
          <!-- Function Calls -->
          @if (message.functionCalls && message.functionCalls.length > 0) {
            <div class="functions-section">
              <div class="functions-header">ðŸ”§ Functions Used:</div>
              @for (funcCall of message.functionCalls; track $index) {
                <div class="function-item">
                  <span class="function-name">{{ funcCall.function }}()</span>
                  <div class="function-details">
                    <div class="function-args">Args: {{ funcCall.arguments | json }}</div>
                    <div class="function-result">Result: {{ funcCall.result }}</div>
                  </div>
                </div>
              }
            </div>
          }
          
          <div class="message-time">{{ message.timestamp | date:'short' }}</div>
        </div>
      </div>
    }
    
    @if (isLoading()) {
      <div class="message ai-message">
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    }
  </div>

  @if (error()) {
    <div class="error-message">
      {{ error() }}
    </div>
  }

  <div class="input-container">
    <textarea
      [(ngModel)]="userMessage"
      (keydown)="onKeyPress($event)"
      placeholder="Type your message here... (Press Enter to send)"
      rows="3"
      [disabled]="isLoading()"
      class="message-input"
    ></textarea>
    <button
      (click)="sendMessage()"
      [disabled]="isLoading() || !userMessage.trim()"
      class="send-button"
    >
      <span>Send</span>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</div>

